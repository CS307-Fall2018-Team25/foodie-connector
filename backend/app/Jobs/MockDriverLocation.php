<?php

namespace App\Jobs;

use App\Events\DriverLocationUpdated;
use App\Models\Order;
use App\Models\OrderStatus;
use Illuminate\Bus\Queueable;
use Illuminate\Queue\SerializesModels;
use Illuminate\Queue\InteractsWithQueue;
use Illuminate\Contracts\Queue\ShouldQueue;
use Illuminate\Foundation\Bus\Dispatchable;
use Illuminate\Support\Facades\DB;

class MockDriverLocation implements ShouldQueue
{
    use Dispatchable, InteractsWithQueue, Queueable, SerializesModels;

    const GEO_LOCATIONS = [
        [
            -86.92065238952637,
            40.41388815007207
        ],
        [
            -86.90966606140137,
            40.42414729765765
        ],
        [
            -86.91112518310547,
            40.42408195771912
        ],
        [
            -86.91224098205566,
            40.42408195771912
        ],
        [
            -86.91378593444824,
            40.42408195771912
        ],
        [
            -86.9157600402832,
            40.42421263753269
        ],
        [
            -86.91756248474121,
            40.42414729765765
        ],
        [
            -86.91927909851073,
            40.42414729765765
        ],
        [
            -86.92133903503418,
            40.424343317092344
        ],
        [
            -86.9227123260498,
            40.42414729765765
        ],
        [
            -86.92460060119629,
            40.424343317092344
        ],
        [
            -86.92588806152344,
            40.424343317092344
        ],
        [
            -86.92846298217773,
            40.424277977344246
        ],
        [
            -86.93017959594727,
            40.424277977344246
        ],
        [
            -86.93241119384764,
            40.424277977344246
        ],
        [
            -86.93429946899414,
            40.424343317092344
        ],
        [
            -86.93635940551756,
            40.424277977344246
        ],
        [
            -86.93781852722168,
            40.424277977344246
        ],
        [
            -86.93910598754883,
            40.424016617717136
        ],
        [
            -86.93936347961426,
            40.423167191915596
        ],
        [
            -86.93910598754883,
            40.42212173005032
        ],
        [
            -86.93893432617188,
            40.42094556603021
        ],
        [
            -86.93824768066406,
            40.41957334868296
        ],
        [
            -86.93704605102538,
            40.41885455699726
        ],
        [
            -86.934814453125,
            40.41826644899681
        ],
        [
            -86.93344116210938,
            40.41800506601313
        ],
        [
            -86.93069458007812,
            40.41800506601313
        ],
        [
            -86.92846298217773,
            40.41793972010854
        ],
        [
            -86.9264030456543,
            40.41767833585549
        ],
        [
            -86.92434310913086,
            40.41695952392355
        ],
        [
            -86.92288398742674,
            40.41630605186676
        ],
        [
            -86.92202568054199,
            40.41526048337471
        ],
        [
            -86.90923690795898,
            40.42408195771912
        ],
        [
            -86.92030906677246,
            40.41369210017261
        ],
        [
            -86.91962242126463,
            40.412842544007816
        ],
        [
            -86.91936492919922,
            40.411666217764925
        ],
        [
            -86.91962242126463,
            40.41048987095918
        ],
        [
            -86.91987991333008,
            40.40944421209154
        ],
        [
            -86.91987991333008,
            40.40813711565967
        ],
        [
            -86.9183349609375,
            40.408267826445226
        ],
        [
            -86.91713333129883,
            40.40892137656509
        ],
        [
            -86.91584587097168,
            40.40957492033851
        ],
        [
            -86.91464424133301,
            40.41016310430832
        ],
        [
            -86.91387176513672,
            40.41101269430034
        ],
        [
            -86.91309928894043,
            40.41173156976231
        ],
        [
            -86.91206932067871,
            40.41231973488292
        ],
        [
            -86.91129684448242,
            40.41316929764821
        ],
        [
            -86.91052436828613,
            40.413953499911635
        ],
        [
            -86.90949440002441,
            40.41480304205038
        ],
        [
            -86.9084644317627,
            40.41578326965167
        ],
        [
            -86.9076919555664,
            40.41669813586243
        ],
        [
            -86.9070053100586,
            40.41754764334817
        ],
        [
            -86.90657615661621,
            40.418397140107864
        ],
        [
            -86.9062328338623,
            40.41905059185498
        ],
        [
            -86.90563201904297,
            40.420030757575326
        ],
        [
            -86.90494537353516,
            40.42107625193684
        ],
        [
            -86.90468788146973,
            40.42212173005032
        ],
        [
            -86.90537452697754,
            40.422579121615655
        ],
        [
            -86.90614700317383,
            40.42303651007102
        ],
        [
            -86.90691947937012,
            40.423428554843156
        ],
        [
            -86.90812110900879,
            40.42388593752276
        ],
    ];

    /**
     * Create a new job instance.
     *
     * @return void
     */
    public function __construct()
    {
        //
    }

    /**
     * Execute the job.
     *
     * @return void
     */
    public function handle()
    {
        $index = 0;
        $length = count($this::GEO_LOCATIONS);
        while (true) {
            $geoLocation = $this::GEO_LOCATIONS[$index];
            $orders = Order::select([
                'id',
                DB::raw("(SELECT `status` FROM `order_statuses` WHERE `order_id`=`orders`.`id` ORDER BY `time` "
                    . "DESC LIMIT 1) as `order_status`"),
            ])->having('order_status', OrderStatus::DELIVERING)->get();
            foreach ($orders as $order) {
                event(new DriverLocationUpdated($order->id, $geoLocation[1], $geoLocation[0]));
            }

            $index += 1;
            if ($index >= $length) {
                break;
            }

            sleep(10);
        }
    }
}
